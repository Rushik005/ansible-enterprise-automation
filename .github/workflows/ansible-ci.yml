name: Ansible CI/CD (Matrix + Vault)

on:
  push:
    branches: [ "develop", "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ansible:
    name: Ansible â€“ ${{ matrix.env }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        env: [dev, staging]
        include:
          - env: dev
            branch: develop
          - env: staging
            branch: develop

    if: github.ref_name == matrix.branch

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: |
          pip install --upgrade pip
          pip install ansible ansible-lint

      # ---------- SSH SETUP ----------
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "${{ secrets.KNOWN_HOSTS }}" > ~/.ssh/known_hosts

      # ---------- VAULT SETUP ----------
      - name: Configure Ansible Vault
        run: |
          echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > ~/.vault_pass.txt
          chmod 600 ~/.vault_pass.txt

      # ---------- LINT ----------
      - name: Ansible Lint
        run: ansible-lint .

      # ---------- DRY RUN ----------
      - name: Ansible Dry Run
        run: |
          ansible-playbook -i inventories/${{ matrix.env }}/hosts.yml site.yml --check --vault-password-file ~/.vault_pass.txt

      # ---------- DEPLOY ----------
      - name: Deploy to ${{ matrix.env }}
        run: |
          ansible-playbook -i inventories/${{ matrix.env }}/hosts.yml site.yml --vault-password-file ~/.vault_pass.txt
